const root = '../../..';
const { absolute } = require(`${root}/helper/path`);
const createPromiseCollector = require(`${root}/helper/collect`);
const { default: PromiseProvider } = require(`${root}/react/provider`);
const getInitScripts = require(`${root}/client/scripts`);
const React = require('react');
const { createStore, combineReducers } = require('redux');
const { Provider } = require('react-redux');
const { renderToString, renderToStaticMarkup } = require('react-dom/server');
const { StaticRouter } = require('react-router-dom');
const { Helmet } = require('react-helmet');
const { graphql, buildSchema } = require('graphql');

const reactReduxMiddleware = async (ctx, next, config) => {
    const { method, request, response } = ctx;
    const { body } = response;
    if (body !== undefined) {
        return await next();
    }

    const { routes, layout, reducers, graphqlSchema, graphqlRoot } = config;
    const { url } = request;
    const { default: Layout } = require(absolute(layout));
    const { default: Routes } = require(absolute(routes));
    const { default: reducer } = require(absolute(reducers));
    const promise = createPromiseCollector();
    const store = createStore(combineReducers(reducer));
    const html = await renderRoute({ url, Routes, store, promise });
    const root = React.createElement('ethical-root', { dangerouslySetInnerHTML: { __html: html } });
    const helmet = Helmet.renderStatic();
    const scripts = getInitScripts(store.getState());
    const props = {
        html: helmet.htmlAttributes.toComponent(),
        body: helmet.bodyAttributes.toComponent(),
        title: helmet.title.toComponent(),
        meta: helmet.meta.toComponent(),
        link: helmet.link.toComponent(),
        scripts,
        root
    };

    response.body = renderLayout(Layout, props);

    await next();
};

const reactReduxMiddlewareInit = config => async (ctx, next) => await reactReduxMiddleware(ctx, next, config);

const renderRoute = async context => {
    const router = {};
    const html = await renderReactComponents(Object.assign({}, context, { router }));
    const { url } = router;
    if (url) {
        return renderRoute(Object.assign({}, context, { url }));
    }
    return html;
};

const renderReactComponents = async context => {

    const { url, router, Routes, store, promise } = context;
    const render = () => renderToString(React.createElement(
        PromiseProvider,
        { promise: promise },
        React.createElement(
            Provider,
            { store: store },
            React.createElement(StaticRouter, { context: router, location: url })
        )
    ));

    const html = render();
    const promises = promise();
    const { length } = promises;
    if (length === 0) {
        return html;
    }

    await Promise.all(promises);
    return render();
};

const renderLayout = (Layout, props) => renderToStaticMarkup(React.createElement(Layout, Object.assign({}, props)));

module.exports = reactReduxMiddlewareInit;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZlci9yZWFjdC1yZWR1eC9zcmMvaW5kZXguanMiXSwibmFtZXMiOlsicm9vdCIsImFic29sdXRlIiwicmVxdWlyZSIsImNyZWF0ZVByb21pc2VDb2xsZWN0b3IiLCJkZWZhdWx0IiwiUHJvbWlzZVByb3ZpZGVyIiwiZ2V0SW5pdFNjcmlwdHMiLCJSZWFjdCIsImNyZWF0ZVN0b3JlIiwiY29tYmluZVJlZHVjZXJzIiwiUHJvdmlkZXIiLCJyZW5kZXJUb1N0cmluZyIsInJlbmRlclRvU3RhdGljTWFya3VwIiwiU3RhdGljUm91dGVyIiwiSGVsbWV0IiwiZ3JhcGhxbCIsImJ1aWxkU2NoZW1hIiwicmVhY3RSZWR1eE1pZGRsZXdhcmUiLCJjdHgiLCJuZXh0IiwiY29uZmlnIiwibWV0aG9kIiwicmVxdWVzdCIsInJlc3BvbnNlIiwiYm9keSIsInVuZGVmaW5lZCIsInJvdXRlcyIsImxheW91dCIsInJlZHVjZXJzIiwiZ3JhcGhxbFNjaGVtYSIsImdyYXBocWxSb290IiwidXJsIiwiTGF5b3V0IiwiUm91dGVzIiwicmVkdWNlciIsInByb21pc2UiLCJzdG9yZSIsImh0bWwiLCJyZW5kZXJSb3V0ZSIsIl9faHRtbCIsImhlbG1ldCIsInJlbmRlclN0YXRpYyIsInNjcmlwdHMiLCJnZXRTdGF0ZSIsInByb3BzIiwiaHRtbEF0dHJpYnV0ZXMiLCJ0b0NvbXBvbmVudCIsImJvZHlBdHRyaWJ1dGVzIiwidGl0bGUiLCJtZXRhIiwibGluayIsInJlbmRlckxheW91dCIsInJlYWN0UmVkdXhNaWRkbGV3YXJlSW5pdCIsImNvbnRleHQiLCJyb3V0ZXIiLCJyZW5kZXJSZWFjdENvbXBvbmVudHMiLCJyZW5kZXIiLCJwcm9taXNlcyIsImxlbmd0aCIsIlByb21pc2UiLCJhbGwiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQSxNQUFNQSxPQUFPLFVBQWI7QUFDQSxNQUFNLEVBQUVDLFFBQUYsS0FBZUMsUUFBUyxHQUFFRixJQUFLLGNBQWhCLENBQXJCO0FBQ0EsTUFBTUcseUJBQXlCRCxRQUFTLEdBQUVGLElBQUssaUJBQWhCLENBQS9CO0FBQ0EsTUFBTSxFQUFFSSxTQUFTQyxlQUFYLEtBQStCSCxRQUFTLEdBQUVGLElBQUssaUJBQWhCLENBQXJDO0FBQ0EsTUFBTU0saUJBQWlCSixRQUFTLEdBQUVGLElBQUssaUJBQWhCLENBQXZCO0FBQ0EsTUFBTU8sUUFBUUwsUUFBUSxPQUFSLENBQWQ7QUFDQSxNQUFNLEVBQUVNLFdBQUYsRUFBZUMsZUFBZixLQUFtQ1AsUUFBUSxPQUFSLENBQXpDO0FBQ0EsTUFBTSxFQUFFUSxRQUFGLEtBQWVSLFFBQVEsYUFBUixDQUFyQjtBQUNBLE1BQU0sRUFBRVMsY0FBRixFQUFrQkMsb0JBQWxCLEtBQTJDVixRQUFRLGtCQUFSLENBQWpEO0FBQ0EsTUFBTSxFQUFFVyxZQUFGLEtBQW1CWCxRQUFRLGtCQUFSLENBQXpCO0FBQ0EsTUFBTSxFQUFFWSxNQUFGLEtBQWFaLFFBQVEsY0FBUixDQUFuQjtBQUNBLE1BQU0sRUFBRWEsT0FBRixFQUFXQyxXQUFYLEtBQTJCZCxRQUFRLFNBQVIsQ0FBakM7O0FBRUEsTUFBTWUsdUJBQXVCLE9BQU9DLEdBQVAsRUFBWUMsSUFBWixFQUFrQkMsTUFBbEIsS0FBNkI7QUFDdEQsVUFBTSxFQUFFQyxNQUFGLEVBQVVDLE9BQVYsRUFBbUJDLFFBQW5CLEtBQWdDTCxHQUF0QztBQUNBLFVBQU0sRUFBRU0sSUFBRixLQUFXRCxRQUFqQjtBQUNBLFFBQUlDLFNBQVNDLFNBQWIsRUFBd0I7QUFDcEIsZUFBTyxNQUFNTixNQUFiO0FBQ0g7O0FBRUQsVUFBTSxFQUFFTyxNQUFGLEVBQVVDLE1BQVYsRUFBa0JDLFFBQWxCLEVBQTRCQyxhQUE1QixFQUEyQ0MsV0FBM0MsS0FBMkRWLE1BQWpFO0FBQ0EsVUFBTSxFQUFFVyxHQUFGLEtBQVVULE9BQWhCO0FBQ0EsVUFBTSxFQUFFbEIsU0FBUzRCLE1BQVgsS0FBc0I5QixRQUFRRCxTQUFTMEIsTUFBVCxDQUFSLENBQTVCO0FBQ0EsVUFBTSxFQUFFdkIsU0FBUzZCLE1BQVgsS0FBc0IvQixRQUFRRCxTQUFTeUIsTUFBVCxDQUFSLENBQTVCO0FBQ0EsVUFBTSxFQUFFdEIsU0FBUzhCLE9BQVgsS0FBdUJoQyxRQUFRRCxTQUFTMkIsUUFBVCxDQUFSLENBQTdCO0FBQ0EsVUFBTU8sVUFBVWhDLHdCQUFoQjtBQUNBLFVBQU1pQyxRQUFRNUIsWUFBWUMsZ0JBQWdCeUIsT0FBaEIsQ0FBWixDQUFkO0FBQ0EsVUFBTUcsT0FBTyxNQUFNQyxZQUFZLEVBQUVQLEdBQUYsRUFBT0UsTUFBUCxFQUFlRyxLQUFmLEVBQXNCRCxPQUF0QixFQUFaLENBQW5CO0FBQ0EsVUFBTW5DLE9BQU8sc0NBQWMseUJBQTBCLEVBQUV1QyxRQUFRRixJQUFWLEVBQXhDLEdBQWI7QUFDQSxVQUFNRyxTQUFTMUIsT0FBTzJCLFlBQVAsRUFBZjtBQUNBLFVBQU1DLFVBQVVwQyxlQUFlOEIsTUFBTU8sUUFBTixFQUFmLENBQWhCO0FBQ0EsVUFBTUMsUUFBUTtBQUNWUCxjQUFNRyxPQUFPSyxjQUFQLENBQXNCQyxXQUF0QixFQURJO0FBRVZ0QixjQUFNZ0IsT0FBT08sY0FBUCxDQUFzQkQsV0FBdEIsRUFGSTtBQUdWRSxlQUFPUixPQUFPUSxLQUFQLENBQWFGLFdBQWIsRUFIRztBQUlWRyxjQUFNVCxPQUFPUyxJQUFQLENBQVlILFdBQVosRUFKSTtBQUtWSSxjQUFNVixPQUFPVSxJQUFQLENBQVlKLFdBQVosRUFMSTtBQU1WSixlQU5VO0FBT1YxQztBQVBVLEtBQWQ7O0FBVUF1QixhQUFTQyxJQUFULEdBQWdCMkIsYUFBYW5CLE1BQWIsRUFBcUJZLEtBQXJCLENBQWhCOztBQUVBLFVBQU16QixNQUFOO0FBQ0gsQ0EvQkQ7O0FBaUNBLE1BQU1pQywyQkFBNEJoQyxNQUFELElBQzdCLE9BQU9GLEdBQVAsRUFBWUMsSUFBWixLQUFxQixNQUFNRixxQkFBcUJDLEdBQXJCLEVBQTBCQyxJQUExQixFQUFnQ0MsTUFBaEMsQ0FEL0I7O0FBSUEsTUFBTWtCLGNBQWMsTUFBT2UsT0FBUCxJQUFtQjtBQUNuQyxVQUFNQyxTQUFTLEVBQWY7QUFDQSxVQUFNakIsT0FBTyxNQUFNa0Isd0NBQTJCRixPQUEzQixJQUFvQ0MsTUFBcEMsSUFBbkI7QUFDQSxVQUFNLEVBQUV2QixHQUFGLEtBQVV1QixNQUFoQjtBQUNBLFFBQUl2QixHQUFKLEVBQVM7QUFDTCxlQUFPTyw4QkFBaUJlLE9BQWpCLElBQTBCdEIsR0FBMUIsSUFBUDtBQUNIO0FBQ0QsV0FBT00sSUFBUDtBQUNILENBUkQ7O0FBVUEsTUFBTWtCLHdCQUF3QixNQUFPRixPQUFQLElBQW1COztBQUU3QyxVQUFNLEVBQUV0QixHQUFGLEVBQU91QixNQUFQLEVBQWVyQixNQUFmLEVBQXVCRyxLQUF2QixFQUE4QkQsT0FBOUIsS0FBMENrQixPQUFoRDtBQUNBLFVBQU1HLFNBQVMsTUFBTTdDLGVBQ2pCO0FBQUMsdUJBQUQ7QUFBQSxVQUFpQixTQUFTd0IsT0FBMUI7QUFDSTtBQUFDLG9CQUFEO0FBQUEsY0FBVSxPQUFPQyxLQUFqQjtBQUNJLGdDQUFDLFlBQUQsSUFBYyxTQUFTa0IsTUFBdkIsRUFBK0IsVUFBVXZCLEdBQXpDO0FBREo7QUFESixLQURpQixDQUFyQjs7QUFVQSxVQUFNTSxPQUFPbUIsUUFBYjtBQUNBLFVBQU1DLFdBQVd0QixTQUFqQjtBQUNBLFVBQU0sRUFBRXVCLE1BQUYsS0FBYUQsUUFBbkI7QUFDQSxRQUFJQyxXQUFXLENBQWYsRUFBa0I7QUFDZCxlQUFPckIsSUFBUDtBQUNIOztBQUVELFVBQU1zQixRQUFRQyxHQUFSLENBQVlILFFBQVosQ0FBTjtBQUNBLFdBQU9ELFFBQVA7QUFDSCxDQXRCRDs7QUF3QkEsTUFBTUwsZUFBZSxDQUFDbkIsTUFBRCxFQUFTWSxLQUFULEtBQW1CaEMscUJBQ3BDLG9CQUFDLE1BQUQsb0JBQWtCZ0MsS0FBbEIsRUFEb0MsQ0FBeEM7O0FBSUFpQixPQUFPQyxPQUFQLEdBQWlCVix3QkFBakIiLCJmaWxlIjoidW5rbm93biIsInNvdXJjZVJvb3QiOiJub2RlX21vZHVsZXMvZXRoaWNhbCIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHJvb3QgPSAnLi4vLi4vLi4nXG5jb25zdCB7IGFic29sdXRlIH0gPSByZXF1aXJlKGAke3Jvb3R9L2hlbHBlci9wYXRoYClcbmNvbnN0IGNyZWF0ZVByb21pc2VDb2xsZWN0b3IgPSByZXF1aXJlKGAke3Jvb3R9L2hlbHBlci9jb2xsZWN0YClcbmNvbnN0IHsgZGVmYXVsdDogUHJvbWlzZVByb3ZpZGVyIH0gPSByZXF1aXJlKGAke3Jvb3R9L3JlYWN0L3Byb3ZpZGVyYClcbmNvbnN0IGdldEluaXRTY3JpcHRzID0gcmVxdWlyZShgJHtyb290fS9jbGllbnQvc2NyaXB0c2ApXG5jb25zdCBSZWFjdCA9IHJlcXVpcmUoJ3JlYWN0JylcbmNvbnN0IHsgY3JlYXRlU3RvcmUsIGNvbWJpbmVSZWR1Y2VycyB9ID0gcmVxdWlyZSgncmVkdXgnKVxuY29uc3QgeyBQcm92aWRlciB9ID0gcmVxdWlyZSgncmVhY3QtcmVkdXgnKVxuY29uc3QgeyByZW5kZXJUb1N0cmluZywgcmVuZGVyVG9TdGF0aWNNYXJrdXAgfSA9IHJlcXVpcmUoJ3JlYWN0LWRvbS9zZXJ2ZXInKVxuY29uc3QgeyBTdGF0aWNSb3V0ZXIgfSA9IHJlcXVpcmUoJ3JlYWN0LXJvdXRlci1kb20nKVxuY29uc3QgeyBIZWxtZXQgfSA9IHJlcXVpcmUoJ3JlYWN0LWhlbG1ldCcpXG5jb25zdCB7IGdyYXBocWwsIGJ1aWxkU2NoZW1hIH0gPSByZXF1aXJlKCdncmFwaHFsJylcblxuY29uc3QgcmVhY3RSZWR1eE1pZGRsZXdhcmUgPSBhc3luYyAoY3R4LCBuZXh0LCBjb25maWcpID0+IHtcbiAgICBjb25zdCB7IG1ldGhvZCwgcmVxdWVzdCwgcmVzcG9uc2UgfSA9IGN0eFxuICAgIGNvbnN0IHsgYm9keSB9ID0gcmVzcG9uc2VcbiAgICBpZiAoYm9keSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBuZXh0KClcbiAgICB9XG5cbiAgICBjb25zdCB7IHJvdXRlcywgbGF5b3V0LCByZWR1Y2VycywgZ3JhcGhxbFNjaGVtYSwgZ3JhcGhxbFJvb3QgfSA9IGNvbmZpZ1xuICAgIGNvbnN0IHsgdXJsIH0gPSByZXF1ZXN0XG4gICAgY29uc3QgeyBkZWZhdWx0OiBMYXlvdXQgfSA9IHJlcXVpcmUoYWJzb2x1dGUobGF5b3V0KSlcbiAgICBjb25zdCB7IGRlZmF1bHQ6IFJvdXRlcyB9ID0gcmVxdWlyZShhYnNvbHV0ZShyb3V0ZXMpKVxuICAgIGNvbnN0IHsgZGVmYXVsdDogcmVkdWNlciB9ID0gcmVxdWlyZShhYnNvbHV0ZShyZWR1Y2VycykpXG4gICAgY29uc3QgcHJvbWlzZSA9IGNyZWF0ZVByb21pc2VDb2xsZWN0b3IoKVxuICAgIGNvbnN0IHN0b3JlID0gY3JlYXRlU3RvcmUoY29tYmluZVJlZHVjZXJzKHJlZHVjZXIpKVxuICAgIGNvbnN0IGh0bWwgPSBhd2FpdCByZW5kZXJSb3V0ZSh7IHVybCwgUm91dGVzLCBzdG9yZSwgcHJvbWlzZSB9KVxuICAgIGNvbnN0IHJvb3QgPSA8ZXRoaWNhbC1yb290IGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MPXsgeyBfX2h0bWw6IGh0bWwgfSB9IC8+XG4gICAgY29uc3QgaGVsbWV0ID0gSGVsbWV0LnJlbmRlclN0YXRpYygpXG4gICAgY29uc3Qgc2NyaXB0cyA9IGdldEluaXRTY3JpcHRzKHN0b3JlLmdldFN0YXRlKCkpXG4gICAgY29uc3QgcHJvcHMgPSB7XG4gICAgICAgIGh0bWw6IGhlbG1ldC5odG1sQXR0cmlidXRlcy50b0NvbXBvbmVudCgpLFxuICAgICAgICBib2R5OiBoZWxtZXQuYm9keUF0dHJpYnV0ZXMudG9Db21wb25lbnQoKSxcbiAgICAgICAgdGl0bGU6IGhlbG1ldC50aXRsZS50b0NvbXBvbmVudCgpLFxuICAgICAgICBtZXRhOiBoZWxtZXQubWV0YS50b0NvbXBvbmVudCgpLFxuICAgICAgICBsaW5rOiBoZWxtZXQubGluay50b0NvbXBvbmVudCgpLFxuICAgICAgICBzY3JpcHRzLFxuICAgICAgICByb290XG4gICAgfVxuXG4gICAgcmVzcG9uc2UuYm9keSA9IHJlbmRlckxheW91dChMYXlvdXQsIHByb3BzKVxuXG4gICAgYXdhaXQgbmV4dCgpXG59XG5cbmNvbnN0IHJlYWN0UmVkdXhNaWRkbGV3YXJlSW5pdCA9IChjb25maWcpID0+IChcbiAgICBhc3luYyAoY3R4LCBuZXh0KSA9PiBhd2FpdCByZWFjdFJlZHV4TWlkZGxld2FyZShjdHgsIG5leHQsIGNvbmZpZylcbilcblxuY29uc3QgcmVuZGVyUm91dGUgPSBhc3luYyAoY29udGV4dCkgPT4ge1xuICAgIGNvbnN0IHJvdXRlciA9IHt9XG4gICAgY29uc3QgaHRtbCA9IGF3YWl0IHJlbmRlclJlYWN0Q29tcG9uZW50cyh7IC4uLmNvbnRleHQsIHJvdXRlciB9KVxuICAgIGNvbnN0IHsgdXJsIH0gPSByb3V0ZXJcbiAgICBpZiAodXJsKSB7XG4gICAgICAgIHJldHVybiByZW5kZXJSb3V0ZSh7IC4uLmNvbnRleHQsIHVybCB9KVxuICAgIH1cbiAgICByZXR1cm4gaHRtbFxufVxuXG5jb25zdCByZW5kZXJSZWFjdENvbXBvbmVudHMgPSBhc3luYyAoY29udGV4dCkgPT4ge1xuXG4gICAgY29uc3QgeyB1cmwsIHJvdXRlciwgUm91dGVzLCBzdG9yZSwgcHJvbWlzZSB9ID0gY29udGV4dFxuICAgIGNvbnN0IHJlbmRlciA9ICgpID0+IHJlbmRlclRvU3RyaW5nKFxuICAgICAgICA8UHJvbWlzZVByb3ZpZGVyIHByb21pc2U9e3Byb21pc2V9PlxuICAgICAgICAgICAgPFByb3ZpZGVyIHN0b3JlPXtzdG9yZX0+XG4gICAgICAgICAgICAgICAgPFN0YXRpY1JvdXRlciBjb250ZXh0PXtyb3V0ZXJ9IGxvY2F0aW9uPXt1cmx9PlxuICAgICAgICAgICAgICAgICAgICB7Lyoge1JvdXRlc30gKi99XG4gICAgICAgICAgICAgICAgPC9TdGF0aWNSb3V0ZXI+XG4gICAgICAgICAgICA8L1Byb3ZpZGVyPlxuICAgICAgICA8L1Byb21pc2VQcm92aWRlcj5cbiAgICApXG5cbiAgICBjb25zdCBodG1sID0gcmVuZGVyKClcbiAgICBjb25zdCBwcm9taXNlcyA9IHByb21pc2UoKVxuICAgIGNvbnN0IHsgbGVuZ3RoIH0gPSBwcm9taXNlc1xuICAgIGlmIChsZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIGh0bWxcbiAgICB9XG5cbiAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcylcbiAgICByZXR1cm4gcmVuZGVyKClcbn1cblxuY29uc3QgcmVuZGVyTGF5b3V0ID0gKExheW91dCwgcHJvcHMpID0+IHJlbmRlclRvU3RhdGljTWFya3VwKFxuICAgIDxMYXlvdXQgeyAuLi57IC4uLnByb3BzfSB9IC8+XG4pXG5cbm1vZHVsZS5leHBvcnRzID0gcmVhY3RSZWR1eE1pZGRsZXdhcmVJbml0XG4iXX0=