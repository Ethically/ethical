function _objectWithoutProperties(obj, keys) { var target = {}; for (var i in obj) { if (keys.indexOf(i) >= 0) continue; if (!Object.prototype.hasOwnProperty.call(obj, i)) continue; target[i] = obj[i]; } return target; }

const root = '../../..';
const { setProjectRoot } = require(`${root}/helper/resolve-node`);
const { absolute } = require(`${root}/helper/path`);
const createPromiseCollector = require(`${root}/helper/collect`);
const { default: PromiseProvider } = require(`${root}/react/provider`);
const getInitScripts = require(`${root}/client/scripts`);
const { Helmet } = require(`${root}/react/helmet`);
const React = require('react');
const { Provider } = require('react-redux');
const { renderToString, renderToStaticMarkup } = require('react-dom/server');
const { StaticRouter } = require('react-router-dom');

const setGlobals = request => {

    if (request) {
        global.navigator = { userAgent: request.headers['user-agent'] };
    }

    const resetProjectRoot = setProjectRoot(module.parent.parent.id);

    return () => {
        resetProjectRoot();
        delete global.navigator;
    };
};

const resolveLayoutProps = (html, store) => {
    const root = React.createElement('ethical-root', { dangerouslySetInnerHTML: { __html: html } });
    const scripts = getInitScripts(store.getState());
    const helmet = Helmet.renderStatic();
    const props = {
        html: helmet.htmlAttributes.toComponent(),
        body: helmet.bodyAttributes.toComponent(),
        title: helmet.title.toComponent(),
        meta: helmet.meta.toComponent(),
        link: helmet.link.toComponent(),
        base: helmet.base.toComponent(),
        style: helmet.style.toComponent(),
        noscript: helmet.noscript.toComponent(),
        scripts,
        root
    };
    return props;
};

const reactReduxMiddleware = async (ctx, next, config) => {
    const { method, request, response } = ctx;
    const { body } = response;
    if (body !== undefined) {
        return await next();
    }

    const { Layout, Routes, createStore, graphqlSchema, graphqlRoot } = config;
    const { url } = request;

    const promise = createPromiseCollector();
    const store = createStore();
    const props = await renderRoute({ url, Routes, store, promise, request });

    response.body = renderLayout(Layout, props);

    await next();
};

const renderRoute = async context => {
    const router = {};
    const props = await renderReactComponents(Object.assign({}, context, { router }));
    const { url } = router;
    if (url) {
        return renderRoute(Object.assign({}, context, { url }));
    }
    return props;
};

const renderReactComponents = async context => {

    const { url, router, Routes, store, promise, request } = context;
    const render = () => renderToString(React.createElement(
        PromiseProvider,
        { promise: promise },
        React.createElement(
            Provider,
            { store: store },
            React.createElement(
                StaticRouter,
                { context: router, location: url },
                Routes
            )
        )
    ));

    const resetGlobals = setGlobals(request);
    const html = render();
    resetGlobals();

    const promises = promise();
    const { length } = promises;
    if (length === 0) {
        return resolveLayoutProps(html, store);
    }

    await Promise.all(promises);

    const resetGlobalsAgain = setGlobals(request);
    const final = render();
    resetGlobalsAgain();

    return resolveLayoutProps(final, store);
};

const renderLayout = (Layout, props) => renderToStaticMarkup(React.createElement(Layout, Object.assign({}, props)));

const bootstrap = config => {

    const resetGlobals = setGlobals();

    const { routes, layout, store } = config,
          other = _objectWithoutProperties(config, ['routes', 'layout', 'store']);

    const { default: Layout } = require(absolute(layout));
    const { default: Routes } = require(absolute(routes));
    const { default: createStore } = require(absolute(store));

    resetGlobals();

    return Object.assign({ Layout, Routes, createStore }, other);
};

const reactReduxMiddlewareInit = config => {
    const resolvedConfig = bootstrap(config);
    return async (ctx, next) => await reactReduxMiddleware(ctx, next, resolvedConfig);
};

module.exports = reactReduxMiddlewareInit;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZlci9yZWFjdC1yZWR1eC9zcmMvaW5kZXguanMiXSwibmFtZXMiOlsicm9vdCIsInNldFByb2plY3RSb290IiwicmVxdWlyZSIsImFic29sdXRlIiwiY3JlYXRlUHJvbWlzZUNvbGxlY3RvciIsImRlZmF1bHQiLCJQcm9taXNlUHJvdmlkZXIiLCJnZXRJbml0U2NyaXB0cyIsIkhlbG1ldCIsIlJlYWN0IiwiUHJvdmlkZXIiLCJyZW5kZXJUb1N0cmluZyIsInJlbmRlclRvU3RhdGljTWFya3VwIiwiU3RhdGljUm91dGVyIiwic2V0R2xvYmFscyIsInJlcXVlc3QiLCJnbG9iYWwiLCJuYXZpZ2F0b3IiLCJ1c2VyQWdlbnQiLCJoZWFkZXJzIiwicmVzZXRQcm9qZWN0Um9vdCIsIm1vZHVsZSIsInBhcmVudCIsImlkIiwicmVzb2x2ZUxheW91dFByb3BzIiwiaHRtbCIsInN0b3JlIiwiX19odG1sIiwic2NyaXB0cyIsImdldFN0YXRlIiwiaGVsbWV0IiwicmVuZGVyU3RhdGljIiwicHJvcHMiLCJodG1sQXR0cmlidXRlcyIsInRvQ29tcG9uZW50IiwiYm9keSIsImJvZHlBdHRyaWJ1dGVzIiwidGl0bGUiLCJtZXRhIiwibGluayIsImJhc2UiLCJzdHlsZSIsIm5vc2NyaXB0IiwicmVhY3RSZWR1eE1pZGRsZXdhcmUiLCJjdHgiLCJuZXh0IiwiY29uZmlnIiwibWV0aG9kIiwicmVzcG9uc2UiLCJ1bmRlZmluZWQiLCJMYXlvdXQiLCJSb3V0ZXMiLCJjcmVhdGVTdG9yZSIsImdyYXBocWxTY2hlbWEiLCJncmFwaHFsUm9vdCIsInVybCIsInByb21pc2UiLCJyZW5kZXJSb3V0ZSIsInJlbmRlckxheW91dCIsImNvbnRleHQiLCJyb3V0ZXIiLCJyZW5kZXJSZWFjdENvbXBvbmVudHMiLCJyZW5kZXIiLCJyZXNldEdsb2JhbHMiLCJwcm9taXNlcyIsImxlbmd0aCIsIlByb21pc2UiLCJhbGwiLCJyZXNldEdsb2JhbHNBZ2FpbiIsImZpbmFsIiwiYm9vdHN0cmFwIiwicm91dGVzIiwibGF5b3V0Iiwib3RoZXIiLCJyZWFjdFJlZHV4TWlkZGxld2FyZUluaXQiLCJyZXNvbHZlZENvbmZpZyIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTUEsT0FBTyxVQUFiO0FBQ0EsTUFBTSxFQUFFQyxjQUFGLEtBQXFCQyxRQUFTLEdBQUVGLElBQUssc0JBQWhCLENBQTNCO0FBQ0EsTUFBTSxFQUFFRyxRQUFGLEtBQWVELFFBQVMsR0FBRUYsSUFBSyxjQUFoQixDQUFyQjtBQUNBLE1BQU1JLHlCQUF5QkYsUUFBUyxHQUFFRixJQUFLLGlCQUFoQixDQUEvQjtBQUNBLE1BQU0sRUFBRUssU0FBU0MsZUFBWCxLQUErQkosUUFBUyxHQUFFRixJQUFLLGlCQUFoQixDQUFyQztBQUNBLE1BQU1PLGlCQUFpQkwsUUFBUyxHQUFFRixJQUFLLGlCQUFoQixDQUF2QjtBQUNBLE1BQU0sRUFBRVEsTUFBRixLQUFhTixRQUFTLEdBQUVGLElBQUssZUFBaEIsQ0FBbkI7QUFDQSxNQUFNUyxRQUFRUCxRQUFRLE9BQVIsQ0FBZDtBQUNBLE1BQU0sRUFBRVEsUUFBRixLQUFlUixRQUFRLGFBQVIsQ0FBckI7QUFDQSxNQUFNLEVBQUVTLGNBQUYsRUFBa0JDLG9CQUFsQixLQUEyQ1YsUUFBUSxrQkFBUixDQUFqRDtBQUNBLE1BQU0sRUFBRVcsWUFBRixLQUFtQlgsUUFBUSxrQkFBUixDQUF6Qjs7QUFFQSxNQUFNWSxhQUFjQyxPQUFELElBQWE7O0FBRTVCLFFBQUlBLE9BQUosRUFBYTtBQUNUQyxlQUFPQyxTQUFQLEdBQW1CLEVBQUVDLFdBQVdILFFBQVFJLE9BQVIsQ0FBZ0IsWUFBaEIsQ0FBYixFQUFuQjtBQUNIOztBQUVELFVBQU1DLG1CQUFtQm5CLGVBQWVvQixPQUFPQyxNQUFQLENBQWNBLE1BQWQsQ0FBcUJDLEVBQXBDLENBQXpCOztBQUVBLFdBQU8sTUFBTTtBQUNUSDtBQUNBLGVBQU9KLE9BQU9DLFNBQWQ7QUFDSCxLQUhEO0FBSUgsQ0FaRDs7QUFjQSxNQUFNTyxxQkFBcUIs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TUYscUJBQXFCQyxHQUFyQixFQUEwQkMsSUFBMUIsRUFBZ0M4QixjQUFoQyxDQUZkO0FBS0gsQ0FQRDs7QUFTQXRELE9BQU91RCxPQUFQLEdBQWlCRix3QkFBakIiLCJmaWxlIjoidW5rbm93biIsInNvdXJjZVJvb3QiOiJub2RlX21vZHVsZXMvZXRoaWNhbCIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHJvb3QgPSAnLi4vLi4vLi4nXG5jb25zdCB7IHNldFByb2plY3RSb290IH0gPSByZXF1aXJlKGAke3Jvb3R9L2hlbHBlci9yZXNvbHZlLW5vZGVgKVxuY29uc3QgeyBhYnNvbHV0ZSB9ID0gcmVxdWlyZShgJHtyb290fS9oZWxwZXIvcGF0aGApXG5jb25zdCBjcmVhdGVQcm9taXNlQ29sbGVjdG9yID0gcmVxdWlyZShgJHtyb290fS9oZWxwZXIvY29sbGVjdGApXG5jb25zdCB7IGRlZmF1bHQ6IFByb21pc2VQcm92aWRlciB9ID0gcmVxdWlyZShgJHtyb290fS9yZWFjdC9wcm92aWRlcmApXG5jb25zdCBnZXRJbml0U2NyaXB0cyA9IHJlcXVpcmUoYCR7cm9vdH0vY2xpZW50L3NjcmlwdHNgKVxuY29uc3QgeyBIZWxtZXQgfSA9IHJlcXVpcmUoYCR7cm9vdH0vcmVhY3QvaGVsbWV0YClcbmNvbnN0IFJlYWN0ID0gcmVxdWlyZSgncmVhY3QnKVxuY29uc3QgeyBQcm92aWRlciB9ID0gcmVxdWlyZSgncmVhY3QtcmVkdXgnKVxuY29uc3QgeyByZW5kZXJUb1N0cmluZywgcmVuZGVyVG9TdGF0aWNNYXJrdXAgfSA9IHJlcXVpcmUoJ3JlYWN0LWRvbS9zZXJ2ZXInKVxuY29uc3QgeyBTdGF0aWNSb3V0ZXIgfSA9IHJlcXVpcmUoJ3JlYWN0LXJvdXRlci1kb20nKVxuXG5jb25zdCBzZXRHbG9iYWxzID0gKHJlcXVlc3QpID0+IHtcblxuICAgIGlmIChyZXF1ZXN0KSB7XG4gICAgICAgIGdsb2JhbC5uYXZpZ2F0b3IgPSB7IHVzZXJBZ2VudDogcmVxdWVzdC5oZWFkZXJzWyd1c2VyLWFnZW50J10gfVxuICAgIH1cblxuICAgIGNvbnN0IHJlc2V0UHJvamVjdFJvb3QgPSBzZXRQcm9qZWN0Um9vdChtb2R1bGUucGFyZW50LnBhcmVudC5pZClcblxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgIHJlc2V0UHJvamVjdFJvb3QoKVxuICAgICAgICBkZWxldGUgZ2xvYmFsLm5hdmlnYXRvclxuICAgIH1cbn1cblxuY29uc3QgcmVzb2x2ZUxheW91dFByb3BzID0gKGh0bWwsIHN0b3JlKSA9PiB7XG4gICAgY29uc3Qgcm9vdCA9IDxldGhpY2FsLXJvb3QgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUw9eyB7IF9faHRtbDogaHRtbCB9IH0gLz5cbiAgICBjb25zdCBzY3JpcHRzID0gZ2V0SW5pdFNjcmlwdHMoc3RvcmUuZ2V0U3RhdGUoKSlcbiAgICBjb25zdCBoZWxtZXQgPSBIZWxtZXQucmVuZGVyU3RhdGljKClcbiAgICBjb25zdCBwcm9wcyA9IHtcbiAgICAgICAgaHRtbDogaGVsbWV0Lmh0bWxBdHRyaWJ1dGVzLnRvQ29tcG9uZW50KCksXG4gICAgICAgIGJvZHk6IGhlbG1ldC5ib2R5QXR0cmlidXRlcy50b0NvbXBvbmVudCgpLFxuICAgICAgICB0aXRsZTogaGVsbWV0LnRpdGxlLnRvQ29tcG9uZW50KCksXG4gICAgICAgIG1ldGE6IGhlbG1ldC5tZXRhLnRvQ29tcG9uZW50KCksXG4gICAgICAgIGxpbms6IGhlbG1ldC5saW5rLnRvQ29tcG9uZW50KCksXG4gICAgICAgIGJhc2U6IGhlbG1ldC5iYXNlLnRvQ29tcG9uZW50KCksXG4gICAgICAgIHN0eWxlOiBoZWxtZXQuc3R5bGUudG9Db21wb25lbnQoKSxcbiAgICAgICAgbm9zY3JpcHQ6IGhlbG1ldC5ub3NjcmlwdC50b0NvbXBvbmVudCgpLFxuICAgICAgICBzY3JpcHRzLFxuICAgICAgICByb290XG4gICAgfVxuICAgIHJldHVybiBwcm9wc1xufVxuXG5jb25zdCByZWFjdFJlZHV4TWlkZGxld2FyZSA9IGFzeW5jIChjdHgsIG5leHQsIGNvbmZpZykgPT4ge1xuICAgIGNvbnN0IHsgbWV0aG9kLCByZXF1ZXN0LCByZXNwb25zZSB9ID0gY3R4XG4gICAgY29uc3QgeyBib2R5IH0gPSByZXNwb25zZVxuICAgIGlmIChib2R5ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IG5leHQoKVxuICAgIH1cblxuICAgIGNvbnN0IHsgIExheW91dCwgUm91dGVzLCBjcmVhdGVTdG9yZSwgZ3JhcGhxbFNjaGVtYSwgZ3JhcGhxbFJvb3QgfSA9IGNvbmZpZ1xuICAgIGNvbnN0IHsgdXJsIH0gPSByZXF1ZXN0XG5cbiAgICBjb25zdCBwcm9taXNlID0gY3JlYXRlUHJvbWlzZUNvbGxlY3RvcigpXG4gICAgY29uc3Qgc3RvcmUgPSBjcmVhdGVTdG9yZSgpXG4gICAgY29uc3QgcHJvcHMgPSBhd2FpdCByZW5kZXJSb3V0ZSh7IHVybCwgUm91dGVzLCBzdG9yZSwgcHJvbWlzZSwgcmVxdWVzdCB9KVxuXG4gICAgcmVzcG9uc2UuYm9keSA9IHJlbmRlckxheW91dChMYXlvdXQsIHByb3BzKVxuXG4gICAgYXdhaXQgbmV4dCgpXG59XG5cbmNvbnN0IHJlbmRlclJvdXRlID0gYXN5bmMgKGNvbnRleHQpID0+IHtcbiAgICBjb25zdCByb3V0ZXIgPSB7fVxuICAgIGNvbnN0IHByb3BzID0gYXdhaXQgcmVuZGVyUmVhY3RDb21wb25lbnRzKHsgLi4uY29udGV4dCwgcm91dGVyIH0pXG4gICAgY29uc3QgeyB1cmwgfSA9IHJvdXRlclxuICAgIGlmICh1cmwpIHtcbiAgICAgICAgcmV0dXJuIHJlbmRlclJvdXRlKHsgLi4uY29udGV4dCwgdXJsIH0pXG4gICAgfVxuICAgIHJldHVybiBwcm9wc1xufVxuXG5jb25zdCByZW5kZXJSZWFjdENvbXBvbmVudHMgPSBhc3luYyAoY29udGV4dCkgPT4ge1xuXG4gICAgY29uc3QgeyB1cmwsIHJvdXRlciwgUm91dGVzLCBzdG9yZSwgcHJvbWlzZSwgcmVxdWVzdCB9ID0gY29udGV4dFxuICAgIGNvbnN0IHJlbmRlciA9ICgpID0+IHJlbmRlclRvU3RyaW5nKFxuICAgICAgICA8UHJvbWlzZVByb3ZpZGVyIHByb21pc2U9e3Byb21pc2V9PlxuICAgICAgICAgICAgPFByb3ZpZGVyIHN0b3JlPXtzdG9yZX0+XG4gICAgICAgICAgICAgICAgPFN0YXRpY1JvdXRlciBjb250ZXh0PXtyb3V0ZXJ9IGxvY2F0aW9uPXt1cmx9PlxuICAgICAgICAgICAgICAgICAgICB7Um91dGVzfVxuICAgICAgICAgICAgICAgIDwvU3RhdGljUm91dGVyPlxuICAgICAgICAgICAgPC9Qcm92aWRlcj5cbiAgICAgICAgPC9Qcm9taXNlUHJvdmlkZXI+XG4gICAgKVxuXG4gICAgY29uc3QgcmVzZXRHbG9iYWxzID0gc2V0R2xvYmFscyhyZXF1ZXN0KVxuICAgIGNvbnN0IGh0bWwgPSByZW5kZXIoKVxuICAgIHJlc2V0R2xvYmFscygpXG5cbiAgICBjb25zdCBwcm9taXNlcyA9IHByb21pc2UoKVxuICAgIGNvbnN0IHsgbGVuZ3RoIH0gPSBwcm9taXNlc1xuICAgIGlmIChsZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHJlc29sdmVMYXlvdXRQcm9wcyhodG1sLCBzdG9yZSlcbiAgICB9XG5cbiAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcylcblxuICAgIGNvbnN0IHJlc2V0R2xvYmFsc0FnYWluID0gc2V0R2xvYmFscyhyZXF1ZXN0KVxuICAgIGNvbnN0IGZpbmFsID0gcmVuZGVyKClcbiAgICByZXNldEdsb2JhbHNBZ2FpbigpXG5cbiAgICByZXR1cm4gcmVzb2x2ZUxheW91dFByb3BzKGZpbmFsLCBzdG9yZSlcbn1cblxuY29uc3QgcmVuZGVyTGF5b3V0ID0gKExheW91dCwgcHJvcHMpID0+IHJlbmRlclRvU3RhdGljTWFya3VwKFxuICAgIDxMYXlvdXQgeyAuLi57IC4uLnByb3BzfSB9IC8+XG4pXG5cbmNvbnN0IGJvb3RzdHJhcCA9IChjb25maWcpID0+IHtcblxuICAgIGNvbnN0IHJlc2V0R2xvYmFscyA9IHNldEdsb2JhbHMoKVxuXG4gICAgY29uc3QgeyByb3V0ZXMsIGxheW91dCwgc3RvcmUsIC4uLm90aGVyIH0gPSBjb25maWdcblxuICAgIGNvbnN0IHsgZGVmYXVsdDogTGF5b3V0IH0gPSByZXF1aXJlKGFic29sdXRlKGxheW91dCkpXG4gICAgY29uc3QgeyBkZWZhdWx0OiBSb3V0ZXMgfSA9IHJlcXVpcmUoYWJzb2x1dGUocm91dGVzKSlcbiAgICBjb25zdCB7IGRlZmF1bHQ6IGNyZWF0ZVN0b3JlIH0gPSByZXF1aXJlKGFic29sdXRlKHN0b3JlKSlcblxuICAgIHJlc2V0R2xvYmFscygpXG5cbiAgICByZXR1cm4geyBMYXlvdXQsIFJvdXRlcywgY3JlYXRlU3RvcmUsIC4uLm90aGVyIH1cbn1cblxuY29uc3QgcmVhY3RSZWR1eE1pZGRsZXdhcmVJbml0ID0gKGNvbmZpZykgPT4ge1xuICAgIGNvbnN0IHJlc29sdmVkQ29uZmlnID0gYm9vdHN0cmFwKGNvbmZpZylcbiAgICByZXR1cm4gKFxuICAgICAgICBhc3luYyAoY3R4LCBuZXh0KSA9PiAoXG4gICAgICAgICAgICBhd2FpdCByZWFjdFJlZHV4TWlkZGxld2FyZShjdHgsIG5leHQsIHJlc29sdmVkQ29uZmlnKVxuICAgICAgICApXG4gICAgKVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHJlYWN0UmVkdXhNaWRkbGV3YXJlSW5pdFxuIl19